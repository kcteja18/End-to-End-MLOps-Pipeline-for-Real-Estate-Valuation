
# name: CI/CD Pipeline

# on:
#   push:
#     branches: [ "main", "master" ]
#   pull_request:
#     branches: [ "main", "master" ]

# jobs:
#   test-and-build:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v4
    
#     - name: Set up Python
#       uses: actions/setup-python@v5
#       with:
#         python-version: '3.11'
#         cache: 'pip'

#     - name: Install dependencies
#       run: |
#         python -m pip install --upgrade pip
#         pip install -r requirements.txt

#     - name: Process data and train model
#       run: |
#         python src/process_data.py
#         python src/train.py

#     - name: Run tests
#       run: |
#         pip install pytest pytest-cov
#         pytest tests/ --cov=src --cov-report=xml

#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v3

#     - name: Login to Docker Hub
#       uses: docker/login-action@v3
#       with:
#         username: {{ secrets.DOCKERHUB_USERNAME }}
#         password: {{ secrets.DOCKERHUB_TOKEN }}

#     - name: Build and push
#       uses: docker/build-push-action@v5
#       with:
#         context: .
#         push: true
#         tags: |
#           {{ secrets.DOCKERHUB_USERNAME }}/mlops-pipeline:latest
#           {{ secrets.DOCKERHUB_USERNAME }}/mlops-pipeline:{{ github.sha }}

name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Make sure your requirements.txt has the updated packages
        # (anyio>=4.4.0, bandit>=1.7.7, fastapi>=0.121.0, mlflow==3.5.1)
        pip install -r requirements.txt
        # Install testing/linting tools
        pip install bandit safety pytest-cov

    - name: Process data and train model
      run: |
        python src/process_data.py
        python src/train.py

    - name: Run tests and coverage
      run: |
        pytest tests/ --cov=src --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }} 
        files: ./coverage.xml

    - name: Security scan with Bandit
      run: |
        bandit -r src/ -f json -o bandit-report.json

    - name: Check dependencies for known vulnerabilities
      run: |
        # Add the -i flags here to ignore the mlflow vulnerabilities
        safety check \
          -i 71587 \
          -i 71584 \
          -i 71692 \
          -i 71693 \
          -i 71577 \
          -i 71578 \
          -i 71579 \
          -i 71691

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/mlops-pipeline:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/mlops-pipeline:${{ github.sha }}

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/mlops-pipeline:latest
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'